<!DOCTYPE html>
<html lang="en" x-data="matraTuner()">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hindi Matra Tuner &amp; Deconstructor</title>

  <!-- Alpine.js + Font -->
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Google Transliteration API CSS & loader -->
  <link href="https://www.google.com/uds/modules/elements/transliteration/api.css"
        type="text/css" rel="stylesheet"/>
  <script type="text/javascript" src="gtransapi.js"></script>

  <style>
    :root {
      --primary-color: #d35400;
      --secondary-color: #f39c12;
      --light-bg: #f0f4f8;
      --dark-text: #2c3e50;
      --highlight-color: #3498db;
    }
    body {
      font-family: 'Baloo 2', cursive;
      background: var(--light-bg);
      padding: 1rem;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      color: #333;
    }
    .tuner-card {
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      max-width: 900px;
      width: 100%;
      padding: 2rem;
      text-align: center;
      margin-bottom: 2rem;
    }
    h1, h2, h3 { color: var(--primary-color); font-weight: 700; }
    .section-divider {
      border: 0; height: 2px;
      background: linear-gradient(to right,transparent,var(--secondary-color),transparent);
      margin: 3rem 0;
    }
    p { color: #555; line-height: 1.6; }
    .instruction-text { font-size: 0.9rem; color: #777; margin: -0.5rem 0 1rem; }

    /* Tuner */
    .controls { display:flex;justify-content:center;gap:2rem;flex-wrap:wrap;margin-bottom:1.5rem; }
    select { font-family:inherit;font-size:1.2rem;padding:0.5rem 1rem;border-radius:8px;
             border:2px solid var(--secondary-color);background:#fff; }
    .consonant-display { font-size:6rem;height:120px;display:flex;
                         align-items:center;justify-content:center;margin:1rem 0; }
    .piano-keys { display:flex;justify-content:center;gap:.5rem;flex-wrap:wrap;margin:2rem 0; }
    .key { width:55px;height:180px;border-radius:0 0 8px 8px;
           background:linear-gradient(to bottom,#fff,#f1f1f1);border:2px solid #ccc;
           box-shadow:0 5px 8px rgba(0,0,0,.1);display:flex;flex-direction:column;
           align-items:center;justify-content:flex-end;padding-bottom:.5rem;
           font-size:2rem;cursor:pointer;transition:.15s;position:relative;}
    .key:hover { transform: translateY(-5px); box-shadow:0 8px 12px rgba(0,0,0,.15); }
    .key.active { background:linear-gradient(to bottom,#f1c40f,#e67e22);
                  border-color:#c2950c; transform: translateY(2px);
                  box-shadow:0 2px 4px rgba(0,0,0,.2) inset; }
    .key-name { font-size:.9rem;color:#7f8c8d;margin-bottom:.5rem;font-weight:600; }
    .key-label { font-weight:bold; }

    /* Deconstructor */
    .deconstructor-input-area { display:flex;gap:1rem;align-items:center;margin-top:1rem; }
    .word-input { flex:1;font-size:1.5rem;padding:.5rem 1rem;border:2px solid #ddd;border-radius:8px;
                  transition:border-color .3s;font-family:'Baloo 2',cursive; }
    .word-input:focus { border-color:var(--secondary-color);outline:none; }
    .analyze-button { background:var(--primary-color);color:#fff;font-size:1.2rem;font-weight:600;
                      border:none;padding:.7rem 1.5rem;border-radius:8px;cursor:pointer;
                      transition:background .3s; }
    .analyze-button:hover { background:#e67e22; }
    .playback-controls { display:flex;gap:1.5rem;justify-content:center;align-items:center;margin-top:1.5rem;flex-wrap:wrap; }
    .play-all-button { background:var(--highlight-color);color:#fff;font-size:1.2rem;font-weight:600;
                       padding:.7rem 1.5rem;border:none;border-radius:8px;cursor:pointer;
                       display:flex;align-items:center;gap:.5rem;transition:.3s; }
    .play-all-button:disabled { background:#bdc3c7;cursor:not-allowed; }
    .speed-controls { display:flex;gap:.5rem;background:#ecf0f1;padding:.3rem;border-radius:8px; }
    .speed-controls input { display:none; }
    .speed-controls label { padding:.4rem 1rem;border-radius:6px;cursor:pointer;transition:.3s;font-weight:600; }
    .speed-controls input:checked + label { background:#fff;color:var(--primary-color);
                                             box-shadow:0 2px 5px rgba(0,0,0,.1); }

    .analysis-result { display:flex;flex-wrap:wrap;justify-content:center;gap:1rem;
                       margin-top:1.5rem;padding:1rem;background:#fafafa;border-radius:12px;
                       min-height:80px; }
    .syllable { display:flex;align-items:baseline;padding:.5rem 1.2rem;border-radius:10px;
                background:#e9ecef;font-size:2.5rem;font-weight:600;cursor:pointer;
                transition:.2s;box-shadow:0 4px 6px rgba(0,0,0,.05); }
    .syllable:hover { transform: translateY(-4px); box-shadow:0 6px 12px rgba(0,0,0,.1); }
    .syllable.speaking { background:var(--highlight-color);color:#fff;
                          transform:scale(1.1) translateY(-2px);box-shadow:0 6px 12px rgba(52,152,219,.4);}
    .syllable .inherent-a { font-size:1rem;color:#95a5a6;margin-left:.2rem; }
    @media (max-width:600px) {
      .deconstructor-input-area { flex-direction:column; }
      .playback-controls { flex-direction:column; }
    }

    /* ---- Transliteration ---- */
    .translit-section { max-width:900px;margin:0 auto 2rem;text-align:center; }
    #transliterateTextarea { width:100%;height:150px;font-size:1.2rem;
                             padding:.8rem;border:2px solid #ddd;border-radius:8px;
                             font-family:'Baloo 2',cursive;resize:vertical; }
  </style>
</head>
<body>

  <!-- Matra Tuner Card -->
  <div class="tuner-card">
    <h1>Hindi Matra Tuner</h1>
    <p>Select a consonant and click the piano keys to hear each matra.</p>
    <div class="controls">
      <select x-model="baseConsonant" @change="updateOutput()">
        <template x-for="c in consonants" :key="c">
          <option x-text="c"></option>
        </template>
      </select>
    </div>
    <div class="consonant-display">
      <span x-text="output"></span>
    </div>
    <div class="piano-keys">
      <template x-for="key in matraKeys" :key="key">
        <div class="key" :class="{ 'active': activeMatra===key }" @click="playMatra(key)">
          <div class="key-name" x-text="matras[key].name"></div>
          <div class="key-label" x-text="matras[key].label"></div>
        </div>
      </template>
    </div>
  </div>

  <!-- Transliteration Section -->
  <div class="translit-section">
    <h2>English → Hindi Transliteration</h2>
    <p class="instruction-text">
      Type in Latin letters below, then press <kbd>Ctrl</kbd>+<kbd>G</kbd> to toggle Hindi.
      Your Hindi text will flow directly into the analyzer.
    </p>
    <textarea id="transliterateTextarea" placeholder="Type here…"></textarea>
  </div>

  <hr class="section-divider">

  <!-- Word Deconstructor -->
  <div class="tuner-card">
    <h2>Word Deconstructor</h2>
    <p>Text from the transliteration box (or type here) will be analyzed.</p>
    <div class="deconstructor-input-area">
      <input
        type="text"
        id="word-input-field"
        x-ref="wordInputField"
        x-model="deconstructorInput"
        class="word-input"
        placeholder="Type 'pranam' or प्रणाम"
        @keydown.enter="deconstructWord()"
      />
      <button class="analyze-button" @click="deconstructWord()">Analyze</button>
    </div>

    <div class="playback-controls" x-show="deconstructedWord.length">
      <button class="play-all-button"
              @click="playSequence()"
              :disabled="isSequencePlaying">
        <span x-show="!isSequencePlaying">▶️ Play All</span>
        <span x-show="isSequencePlaying">Playing...</span>
      </button>
      <div class="speed-controls">
        <input type="radio" id="slow" value="0.7" x-model="playbackRate">
        <label for="slow">Slow</label>
        <input type="radio" id="normal" value="1.0" x-model="playbackRate">
        <label for="normal">Normal</label>
        <input type="radio" id="fast" value="1.3" x-model="playbackRate">
        <label for="fast">Fast</label>
      </div>
    </div>

    <div class="analysis-result">
      <template x-if="!deconstructedWord.length">
        <span style="color:#999">Analysis will appear here…</span>
      </template>
      <template x-for="(syll, i) in deconstructedWord" :key="i">
        <div class="syllable"
             @click="playTTS(syll.full, playbackRate)"
             :class="{ 'speaking': currentlySpeakingSyllableIndex===i }"
             :style="{ borderColor: getColor(i) }"
        >
          <span class="base-char" x-text="syll.base"></span>
          <template x-if="syll.matra">
            <span class="matra-char" x-text="syll.matra"></span>
          </template>
          <template x-if="!syll.matra && !syll.isVowel">
            <span class="inherent-a">(+अ)</span>
          </template>
        </div>
      </template>
    </div>
  </div>

  <!-- INITIALIZE TRANSLITERATION & SYNC -->
  <script>
    // Load and configure Google Transliteration
    google.load("elements","1",{packages:"transliteration"});
    function onTranslitLoad() {
      const opts = {
        sourceLanguage: google.elements.transliteration.LanguageCode.ENGLISH,
        destinationLanguage: [google.elements.transliteration.LanguageCode.HINDI],
        shortcutKey: "ctrl+g",
        transliterationEnabled: true
      };
      const control = new google.elements.transliteration.TransliterationControl(opts);
      control.makeTransliteratable(["transliterateTextarea"]);

      // whenever the translit textarea changes, push its value into our Alpine input
      const txt = document.getElementById("transliterateTextarea");
      const inp = document.getElementById("word-input-field");
      txt.addEventListener("input", () => {
        inp.value = txt.value;
        inp.dispatchEvent(new Event("input"));
      });
    }
    google.setOnLoadCallback(onTranslitLoad);
  </script>

  <!-- YOUR Alpine.js COMPONENT -->
  <script>
    function matraTuner() {
      const H_CONS = ['क','ख','ग','घ','ङ','च','छ','ज','झ','ञ',
                      'ट','ठ','ड','ढ','ण','त','थ','द','ध','न',
                      'प','फ','ब','भ','म','य','र','ल','व','श','ष','स','ह'];
      const H_MATRAS = {
        none:{label:'',name:'a',suffix:''},
        aa:{label:'ा',name:'ā',suffix:'ा'},
        i:{label:'ि',name:'i',suffix:'ि',prepend:true},
        ii:{label:'ी',name:'ī',suffix:'ी'},
        u:{label:'ु',name:'u',suffix:'ु'},
        uu:{label:'ू',name:'ū',suffix:'ू'},
        e:{label:'े',name:'e',suffix:'े'},
        ai:{label:'ै',name:'ai',suffix:'ै'},
        o:{label:'ो',name:'o',suffix:'ो'},
        au:{label:'ौ',name:'au',suffix:'ौ'},
        an:{label:'ं',name:'aṃ',suffix:'ं'},
        ah:{label:'ः',name:'aḥ',suffix:'ः'},
      };
      const MATRA_CH = new Set(Object.values(H_MATRAS).map(m => m.suffix).filter(Boolean));
      const VOW_CH  = new Set(['अ','आ','इ','ई','उ','ऊ','ऋ','ए','ऐ','ओ','औ']);
      const VIRAMA = '्';

      return {
        // tuner state
        baseConsonant: 'क', activeMatra:'none', output:'क',
        consonants: H_CONS, matras: H_MATRAS,
        get matraKeys(){ return Object.keys(this.matras) },
        updateOutput(){ this.applyMatra(this.activeMatra) },
        applyMatra(k){
          const m=this.matras[k];
          this.output = m.prepend
            ? m.suffix+this.baseConsonant
            : this.baseConsonant+m.suffix;
          this.activeMatra=k;
        },
        playMatra(k){ this.applyMatra(k); this.playTTS(this.output,1.0) },

        // deconstructor state
        deconstructorInput:'नमस्ते',
        deconstructedWord:[],
        rainbowColors:['#e74c3c','#3498db','#2ecc71','#9b59b6','#f1c40f','#1abc9c','#e67e22'],
        playbackRate:'1.0',
        isSequencePlaying:false,
        currentlySpeakingSyllableIndex:null,

        init(){ this.deconstructWord() },
        getColor(i){ return this.rainbowColors[i%this.rainbowColors.length] },

        deconstructWord(){
          if(this.isSequencePlaying) window.speechSynthesis.cancel();
          // sync Alpine to actual DOM input (contains translit text)
          this.deconstructorInput = this.$refs.wordInputField.value.trim();
          if(!this.deconstructorInput){ this.deconstructedWord=[]; return }
          const w=this.deconstructorInput;
          const syls=[]; let i=0;
          while(i<w.length){
            const start=i;
            if(VOW_CH.has(w[i])) i++;
            else {
              i++;
              while(i<w.length && w[i]===VIRAMA) i+=2;
            }
            if(i<w.length && MATRA_CH.has(w[i])) i++;
            syls.push(w.slice(start,i));
          }
          this.deconstructedWord = syls.map(s=>{
            const last=s.slice(-1), base=MATRA_CH.has(last)?s.slice(0,-1):s;
            return { full:s, base, matra: MATRA_CH.has(last)?last:'', isVowel:VOW_CH.has(s) };
          });
        },

        playTTS(txt,rate){
          if(!('speechSynthesis' in window)||this.isSequencePlaying) return;
          window.speechSynthesis.cancel();
          const u=new SpeechSynthesisUtterance(txt);
          u.lang='hi-IN'; u.rate=rate;
          window.speechSynthesis.speak(u);
        },

        async playSequence(){
          if(this.isSequencePlaying||!this.deconstructedWord.length) return;
          this.isSequencePlaying=true;
          window.speechSynthesis.cancel();
          const pause=t=>new Promise(r=>setTimeout(r,t));
          try {
            for(let i=0;i<this.deconstructedWord.length;i++){
              this.currentlySpeakingSyllableIndex=i;
              await new Promise((res,rej)=>{
                const u=new SpeechSynthesisUtterance(this.deconstructedWord[i].full);
                u.lang='hi-IN'; u.rate=parseFloat(this.playbackRate);
                u.onend=res; u.onerror=rej;
                window.speechSynthesis.speak(u);
              });
              this.currentlySpeakingSyllableIndex=null;
              await pause(400/this.playbackRate);
            }
            await pause(600/this.playbackRate);
            // final full word
            await new Promise(res=>{
              const u=new SpeechSynthesisUtterance(this.deconstructorInput);
              u.lang='hi-IN'; u.rate=parseFloat(this.playbackRate);
              u.onend=res; window.speechSynthesis.speak(u);
            });
          } catch(e){ console.error(e) }
          finally {
            this.isSequencePlaying=false;
            this.currentlySpeakingSyllableIndex=null;
          }
        }
      }
    }

    document.addEventListener('alpine:init', () => {
      Alpine.data('matraTuner', matraTuner);
    });
  </script>
</body>
</html>
