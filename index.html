<!DOCTYPE html>
<html lang="en" x-data="matraTuner()">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hindi Matra Tuner & Deconstructor</title>

  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Alpine.js -->
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <!-- Google Transliteration API -->
  <link
    href="https://www.google.com/uds/modules/elements/transliteration/api.css"
    rel="stylesheet"
  />
   <script type="text/javascript" src="gtransapi.js"></script>
</head>
<body class="bg-gray-100 font-sans text-gray-800 flex flex-col items-center p-4">

  <!-- Matra Tuner Card -->
  <div class="bg-white rounded-2xl shadow-lg max-w-3xl w-full p-6 mb-8">
    <h1 class="text-3xl font-bold text-orange-600 mb-2">Hindi Matra Tuner</h1>
    <p class="text-gray-600 mb-4">Select a consonant and click the piano keys to hear each matra.</p>

    <div class="flex flex-wrap justify-center gap-4 mb-6">
      <select
        x-model="baseConsonant"
        @change="updateOutput()"
        class="border-2 border-yellow-500 rounded-lg px-4 py-2 text-lg focus:outline-none focus:ring-2 focus:ring-yellow-300"
      >
        <template x-for="c in consonants" :key="c">
          <option x-text="c"></option>
        </template>
      </select>
    </div>

    <div class="text-6xl h-32 flex items-center justify-center mb-6">
      <span x-text="output"></span>
    </div>

    <div class="flex flex-wrap justify-center gap-2">
      <template x-for="key in matraKeys" :key="key">
        <button
          @click="playMatra(key)"
          class="group relative w-12 h-40 bg-gradient-to-b from-white to-gray-100 border-2 border-gray-300 rounded-b-lg shadow hover:-translate-y-1 hover:shadow-lg transition transform"
          :class="activeMatra===key ? 'from-yellow-300 to-orange-400 border-yellow-500' : ''"
        >
          <div class="text-xs text-gray-500 group-hover:text-gray-700 font-semibold mb-1">
            <span x-text="matras[key].name"></span>
          </div>
          <div class="text-2xl font-bold">
            <span x-text="matras[key].label"></span>
          </div>
        </button>
      </template>
    </div>
  </div>

  <!-- Transliteration Section -->
  <div class="max-w-3xl w-full mb-8">
    <h2 class="text-2xl font-bold text-orange-600 mb-2">English → Hindi Transliteration</h2>
    <p class="text-gray-600 mb-2">
      Type in Latin letters below and press <b>space</b>, And press <kbd class="px-1 bg-gray-200 rounded">Ctrl</kbd>+
      <kbd class="px-1 bg-gray-200 rounded">G</kbd> if you want to toggle between hindi and english. Your Hindi text will flow
      directly into the analyzer.
    </p>
    <textarea
      x-ref="translit"
      id="transliterateTextarea"
      class="w-full h-32 p-4 border-2 border-gray-300 rounded-lg resize-y focus:outline-none focus:ring-2 focus:ring-yellow-300"
      placeholder="Type here…"
    ></textarea>

    <!-- NEW: Show raw Latin vs. Hindi -->
    <div class="mt-4 bg-white p-4 rounded-lg shadow-sm space-y-1">
      <p><span class="font-semibold">Latin Input:</span> <span x-text="rawLatin"></span></p>
      <p><span class="font-semibold">Hindi Transliteration:</span> <span x-text="transliteration"></span></p>
    </div>
  </div>

  <hr class="border-t-2 border-yellow-400 w-full max-w-3xl mb-8">

  <!-- Word Deconstructor -->
  <div class="bg-white rounded-2xl shadow-lg max-w-3xl w-full p-6 mb-8">
    <h2 class="text-2xl font-bold text-orange-600 mb-2">Word Deconstructor</h2>
    <p class="text-gray-600 mb-4">
      Text from the transliteration box (or type here) will be analyzed.
    </p>

    <div class="flex flex-wrap gap-4 mb-6">
      <input
        type="text"
        id="word-input-field"
        x-ref="wordInputField"
        x-model="deconstructorInput"
        @keydown.enter="deconstructWord()"
        class="flex-1 border-2 border-gray-300 rounded-lg px-4 py-2 text-xl focus:outline-none focus:ring-2 focus:ring-yellow-300"
        placeholder="Type 'pranam' or प्रणाम"
      />
      <button
        @click="deconstructWord()"
        class="bg-orange-600 text-white font-semibold px-6 py-2 rounded-lg hover:bg-orange-700 transition"
      >
        Analyze
      </button>
    </div>

    <div
      class="flex flex-col sm:flex-row sm:items-center gap-4 mb-6"
      x-show="deconstructedWord.length"
    >
      <button
        @click="playSequence()"
        :disabled="isSequencePlaying"
        class="flex items-center gap-2 bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 disabled:bg-gray-300 transition"
      >
        <span x-show="!isSequencePlaying">▶️ Play All</span>
        <span x-show="isSequencePlaying">Playing…</span>
      </button>
      <div class="flex gap-2 bg-gray-100 p-2 rounded-lg">
        <template x-for="rate in ['0.7','1.0','1.3']" :key="rate">
          <label
            class="flex items-center gap-1 cursor-pointer px-3 py-1 rounded-md hover:bg-white transition"
            :class="playbackRate===rate ? 'bg-white text-orange-600 ring-2 ring-yellow-300' : ''"
          >
            <input
              type="radio"
              :value="rate"
              x-model="playbackRate"
              class="hidden"
            />
            <span x-text="rate==='0.7' ? 'Slow' : rate==='1.0' ? 'Normal' : 'Fast'"></span>
          </label>
        </template>
      </div>
    </div>

    <div class="flex flex-wrap gap-4">
      <template x-if="!deconstructedWord.length">
        <span class="text-gray-400">Analysis will appear here…</span>
      </template>
      <template x-for="(syll, i) in deconstructedWord" :key="i">
        <div
          @click="playTTS(syll.full, playbackRate)"
          class="flex items-baseline gap-1 p-3 bg-gray-200 rounded-xl text-2xl font-semibold cursor-pointer transform transition hover:-translate-y-1 hover:shadow-lg"
          :class="currentlySpeakingSyllableIndex===i ? 'bg-blue-500 text-white scale-105' : ''"
          :style="{ borderColor: getColor(i) }"
        >
          <span x-text="syll.base"></span>
          <template x-if="syll.matra">
            <span x-text="syll.matra"></span>
          </template>
          <template x-if="!syll.matra && !syll.isVowel">
            <span class="text-gray-500 text-lg">(+अ)</span>
          </template>
        </div>
      </template>
    </div>
  </div>

  <!-- Initialize Transliteration & Sync -->
  <script>
    google.load("elements","1",{packages:"transliteration"});
    function onTranslitLoad() {
      const opts = {
        sourceLanguage: google.elements.transliteration.LanguageCode.ENGLISH,
        destinationLanguage: [google.elements.transliteration.LanguageCode.HINDI],
        shortcutKey: "ctrl+g",
        transliterationEnabled: true
      };
      const control = new google.elements.transliteration.TransliterationControl(opts);
      control.makeTransliteratable(["transliterateTextarea"]);
    }
    google.setOnLoadCallback(onTranslitLoad);
  </script>

  <!-- Alpine.js Component -->
  <script>
    function matraTuner() {
      const H_CONS = ['क','ख','ग','घ','ङ','च','छ','ज','झ','ञ',
                      'ट','ठ','ड','ढ','ण','त','थ','द','ध','न',
                      'प','फ','ब','भ','म','य','र','ल','व','श','ष','स','ह'];
      const H_MATRAS = {
        none:{label:'',name:'a',suffix:''},
        aa:{label:'ा',name:'ā',suffix:'ा'},
        i:{label:'ि',name:'i',suffix:'ि',prepend:true},
        ii:{label:'ी',name:'ī',suffix:'ी'},
        u:{label:'ु',name:'u',suffix:'ु'},
        uu:{label:'ू',name:'ū',suffix:'ू'},
        e:{label:'े',name:'e',suffix:'े'},
        ai:{label:'ै',name:'ai',suffix:'ै'},
        o:{label:'ो',name:'o',suffix:'ो'},
        au:{label:'ौ',name:'au',suffix:'ौ'},
        an:{label:'ं',name:'aṃ',suffix:'ं'},
        ah:{label:'ः',name:'aḥ',suffix:'ः'},
      };
      const MATRA_CH = new Set(Object.values(H_MATRAS).map(m => m.suffix).filter(Boolean));
      const VOW_CH  = new Set(['अ','आ','इ','ई','उ','ऊ','ऋ','ए','ऐ','ओ','औ']);
      const VIRAMA = '्';

      return {
        // … existing state …

        // NEW state for display:
        rawLatin: '',
        transliteration: '',
        baseConsonant: 'क', activeMatra:'none', output:'क',
        consonants: H_CONS, matras: H_MATRAS,
        get matraKeys(){ return Object.keys(this.matras) },
        updateOutput(){ this.applyMatra(this.activeMatra) },
        applyMatra(k){
          const m=this.matras[k];
          this.output = m.prepend
            ? m.suffix+this.baseConsonant
            : this.baseConsonant+m.suffix;
          this.activeMatra=k;
        },
        playMatra(k){ this.applyMatra(k); this.playTTS(this.output,1.0) },

        // deconstructor state
        deconstructorInput:'नमस्ते',
        deconstructedWord:[],
        rainbowColors:['#e74c3c','#3498db','#2ecc71','#9b59b6','#f1c40f','#1abc9c','#e67e22'],
        playbackRate:'1.0',
        isSequencePlaying:false,
        currentlySpeakingSyllableIndex:null,


        init() {
          this.deconstructWord()
          // your existing init (e.g. this.deconstructWord())
          // now wire up our refs:
          this.$nextTick(() => {
            const ta = this.$refs.translit;
            // track raw keystrokes
            ta.addEventListener('keydown', e => {
              if (e.key === 'Backspace') {
                this.rawLatin = this.rawLatin.slice(0, -1);
              } else if (e.key.length === 1) {
                this.rawLatin += e.key;
              }
            });
            // capture post-transliteration text
            ta.addEventListener('input', () => {
              this.transliteration = ta.value;
              // keep your existing sync into the deconstructor
              const inp = this.$refs.wordInputField;
              inp.value = ta.value;
              inp.dispatchEvent(new Event('input'));
            });
          });
        },
         getColor(i){ return this.rainbowColors[i%this.rainbowColors.length] },

        deconstructWord(){
          if(this.isSequencePlaying) window.speechSynthesis.cancel();
          // sync Alpine to actual DOM input (contains translit text)
          this.deconstructorInput = this.$refs.wordInputField.value.trim();
          if(!this.deconstructorInput){ this.deconstructedWord=[]; return }
          const w=this.deconstructorInput;
          const syls=[]; let i=0;
          while(i<w.length){
            const start=i;
            if(VOW_CH.has(w[i])) i++;
            else {
              i++;
              while(i<w.length && w[i]===VIRAMA) i+=2;
            }
            if(i<w.length && MATRA_CH.has(w[i])) i++;
            syls.push(w.slice(start,i));
          }
          this.deconstructedWord = syls.map(s=>{
            const last=s.slice(-1), base=MATRA_CH.has(last)?s.slice(0,-1):s;
            return { full:s, base, matra: MATRA_CH.has(last)?last:'', isVowel:VOW_CH.has(s) };
          });
        },

        playTTS(txt,rate){
          if(!('speechSynthesis' in window)||this.isSequencePlaying) return;
          window.speechSynthesis.cancel();
          const u=new SpeechSynthesisUtterance(txt);
          u.lang='hi-IN'; u.rate=rate;
          window.speechSynthesis.speak(u);
        },

        async playSequence(){
          if(this.isSequencePlaying||!this.deconstructedWord.length) return;
          this.isSequencePlaying=true;
          window.speechSynthesis.cancel();
          const pause=t=>new Promise(r=>setTimeout(r,t));
          try {
            for(let i=0;i<this.deconstructedWord.length;i++){
              this.currentlySpeakingSyllableIndex=i;
              await new Promise((res,rej)=>{
                const u=new SpeechSynthesisUtterance(this.deconstructedWord[i].full);
                u.lang='hi-IN'; u.rate=parseFloat(this.playbackRate);
                u.onend=res; u.onerror=rej;
                window.speechSynthesis.speak(u);
              });
              this.currentlySpeakingSyllableIndex=null;
              await pause(400/this.playbackRate);
            }
            await pause(600/this.playbackRate);
            // final full word
            await new Promise(res=>{
              const u=new SpeechSynthesisUtterance(this.deconstructorInput);
              u.lang='hi-IN'; u.rate=parseFloat(this.playbackRate);
              u.onend=res; window.speechSynthesis.speak(u);
            });
          } catch(e){ console.error(e) }
          finally {
            this.isSequencePlaying=false;
            this.currentlySpeakingSyllableIndex=null;
          }
        }
      }
    }

    document.addEventListener('alpine:init', () => {
      Alpine.data('matraTuner', matraTuner);
    });
  </script>
</body>
</html>
